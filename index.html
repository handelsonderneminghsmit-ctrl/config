<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chiptuning Configurator – HS Performance</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #14171f;
    --panel:     #1b1f2b;
    --panel2:    #20253300;
    --field-bg:  #0f1118;
    --border:    #2c3040;
    --border-hi: #3d4258;
    --red:       #cc1020;
    --red-hot:   #e8132a;
    --red-dim:   rgba(204,16,32,.15);
    --red-glow:  rgba(232,19,42,.25);
    --text:      #f0f2f8;
    --muted:     #636880;
    --muted2:    #9098b0;
    --success:   #20c958;
    --success-dim: rgba(32,201,88,.12);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  .configurator {
    width: 100%;
    background: var(--panel);
    position: relative;
    overflow: hidden;
  }

  .configurator::before {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 420px; height: 100%;
    background: linear-gradient(105deg, transparent 38%, rgba(204,16,32,.07) 38%, rgba(204,16,32,.03) 100%);
    pointer-events: none;
    z-index: 0;
  }
  .configurator::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .red-stripe {
    height: 3px;
    background: linear-gradient(90deg, var(--red) 0%, var(--red-hot) 60%, transparent 100%);
  }

  .cfg-header {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 22px 32px 0;
  }

  .cfg-title-block {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .slash-mark {
    width: 6px;
    height: 48px;
    background: linear-gradient(180deg, var(--red-hot) 0%, var(--red) 100%);
    clip-path: polygon(20% 0%, 100% 0%, 80% 100%, 0% 100%);
    flex-shrink: 0;
  }

  .cfg-title {
    font-family: 'Playfair Display', serif;
    font-weight: 900;
    font-size: 1.9rem;
    text-transform: none;
    letter-spacing: .01em;
    line-height: 1;
    color: var(--text);
  }
  .cfg-title span { color: var(--red-hot); }

  .cfg-subtitle {
    font-size: .72rem;
    text-transform: uppercase;
    letter-spacing: .16em;
    color: var(--muted);
    margin-top: 4px;
  }

  .cfg-tagline {
    margin-left: auto;
    font-family: 'DM Sans', sans-serif;
    font-size: .78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .12em;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 5px 12px;
    border-radius: 2px;
    white-space: nowrap;
  }

  .step-track {
    position: relative;
    z-index: 1;
    display: flex;
    gap: 0;
    padding: 18px 32px 0;
    align-items: center;
  }
  .step-item {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: .3;
    transition: opacity .3s;
  }
  .step-item.active { opacity: 1; }
  .step-item.done   { opacity: .55; }

  .step-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 1.5px solid var(--border-hi);
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Sans', sans-serif;
    font-size: .72rem;
    font-weight: 800;
    color: var(--muted2);
    flex-shrink: 0;
    transition: background .3s, border-color .3s, color .3s;
  }
  .step-item.active .step-num {
    background: var(--red);
    border-color: var(--red-hot);
    color: #fff;
    box-shadow: 0 0 10px var(--red-glow);
  }
  .step-item.done .step-num {
    background: var(--border);
    border-color: var(--border-hi);
    color: var(--muted2);
  }
  .step-item.done .step-num::after { content: '✓'; font-size: .65rem; }
  .step-item.done .step-num span   { display: none; }

  .step-label {
    font-family: 'DM Sans', sans-serif;
    font-size: .78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--muted2);
    white-space: nowrap;
  }
  .step-item.active .step-label { color: var(--text); }

  .step-sep {
    flex: 1;
    height: 1px;
    background: var(--border);
    margin: 0 10px;
    min-width: 16px;
  }

  .fields-row {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr 2fr;
    gap: 1px;
    margin: 16px 32px 0;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  .field-cell {
    background: var(--field-bg);
    padding: 0;
    opacity: .3;
    pointer-events: none;
    transition: opacity .3s, background .2s;
    position: relative;
  }
  .field-cell.unlocked {
    opacity: 1;
    pointer-events: all;
  }
  .field-cell.unlocked:hover {
    background: #13161e;
  }
  .field-cell.active-field::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--red-hot);
    z-index: 2;
  }

  .field-label {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 14px 0;
    font-size: .62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .14em;
    color: var(--muted);
    pointer-events: none;
  }
  .field-label .dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--border-hi);
    flex-shrink: 0;
    transition: background .3s;
  }
  .field-cell.unlocked .field-label .dot { background: var(--red); }
  .field-cell.active-field .field-label { color: var(--muted2); }

  .sel-wrap { position: relative; }
  .sel-wrap::after {
    content: '▾';
    position: absolute;
    right: 14px; top: 50%;
    transform: translateY(-50%);
    color: var(--red);
    pointer-events: none;
    font-size: .9rem;
    opacity: .8;
  }

  select {
    width: 100%;
    appearance: none;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: .01em;
    padding: 6px 36px 12px 14px;
    cursor: pointer;
  }
  select option, select optgroup {
    background: #1a1e28;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: .9rem;
    font-weight: 400;
  }
  select optgroup {
    color: var(--red-hot);
    font-weight: 700;
    font-size: .78rem;
    text-transform: uppercase;
    letter-spacing: .06em;
  }
  select:disabled { cursor: not-allowed; }

  .loading-msg {
    display: none;
    position: relative;
    z-index: 1;
    padding: 10px 32px;
    font-size: .78rem;
    color: var(--muted2);
    letter-spacing: .06em;
  }
  .loading-msg.show { display: block; }

  .error-msg {
    display: none;
    position: relative;
    z-index: 1;
    padding: 10px 32px;
    font-size: .78rem;
    color: var(--red-hot);
    letter-spacing: .06em;
  }
  .error-msg.show { display: block; }

  /* ── RESULT PANEL ── */
  .result-panel {
    display: none;
    position: relative; z-index: 1;
    margin: 1px 32px 0;
    background: #0f1118;
    border: 1px solid var(--border);
    border-top: 2px solid var(--red);
    flex-direction: column;
    animation: slideDown .3s ease;
  }
  .result-panel.show { display: flex; }

  @keyframes slideDown {
    from { opacity:0; transform: translateY(-8px); }
    to   { opacity:1; transform: translateY(0); }
  }

  /* Top row: car info + 4 stats */
  .result-top {
    display: flex;
  }

  .result-main {
    flex: 1;
    padding: 18px 24px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }

  .result-eyebrow {
    font-size: .62rem;
    font-weight: 700;
    font-family: 'DM Sans', sans-serif;
    text-transform: uppercase;
    letter-spacing: .18em;
    color: var(--red-hot);
    margin-bottom: 5px;
  }

  .result-car-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: .01em;
    line-height: 1.05;
    color: var(--text);
  }
  .result-car-name .yr { color: var(--red-hot); }

  .result-engine {
    margin-top: 4px;
    font-size: .8rem;
    color: var(--muted2);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .fuel-badge {
    background: var(--red-dim);
    border: 1px solid rgba(204,16,32,.3);
    color: var(--red-hot);
    font-size: .62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .1em;
    padding: 2px 8px;
    border-radius: 2px;
  }

  /* Stats grid — 4 columns top row */
  .stats-grid {
    flex-shrink: 0;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    border-left: none;
    border-bottom: 1px solid var(--border);
  }

  .stat-box {
    padding: 18px 20px;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
  }
  .stat-box.new {
    background: rgba(255,255,255,.02);
  }
  .stat-box.gain {
    background: var(--success-dim);
    border-left-color: rgba(32,201,88,.2);
  }
  .stat-box.gain::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--success);
    opacity: .5;
  }

  .stat-val {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 900;
    line-height: 1;
    color: var(--muted2);
  }
  .stat-box.new  .stat-val  { color: var(--text); }
  .stat-box.gain .stat-val  { color: var(--success); }

  .stat-lbl {
    font-size: .6rem;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--muted);
    margin-top: 3px;
  }

  /* ── GAIN BAR ROW ── */
  .gain-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-top: none;
  }

  .gain-bar-cell {
    padding: 14px 20px 16px;
    border-left: 1px solid var(--border);
    position: relative;
  }
  .gain-bar-cell:first-child { border-left: none; }

  .gain-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 8px;
  }
  .gain-bar-label {
    font-size: .6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .14em;
    color: var(--muted);
  }
  .gain-bar-numbers {
    font-size: .72rem;
    font-weight: 700;
    color: var(--muted2);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .gain-bar-numbers .before { color: var(--muted); }
  .gain-bar-numbers .arrow  { color: var(--border-hi); font-size: .6rem; }
  .gain-bar-numbers .after  { color: var(--text); }
  .gain-bar-numbers .delta  {
    color: var(--success);
    font-size: .68rem;
    background: var(--success-dim);
    border: 1px solid rgba(32,201,88,.2);
    padding: 1px 6px;
    border-radius: 2px;
  }

  /* The actual bar */
  .bar-track {
    height: 6px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    position: relative;
  }

  /* Stock fill */
  .bar-stock {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: var(--border-hi);
    border-radius: 2px;
    transition: width .6s cubic-bezier(.22,1,.36,1);
  }

  /* Stage 1 fill (animated on top) */
  .bar-stage {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: linear-gradient(90deg, var(--red) 0%, var(--red-hot) 100%);
    border-radius: 2px;
    transition: width .8s cubic-bezier(.22,1,.36,1) .1s;
  }

  /* Gain segment (the extra bit) */
  .bar-gain {
    position: absolute;
    top: 0; bottom: 0;
    background: var(--success);
    border-radius: 0 2px 2px 0;
    transition: left .8s cubic-bezier(.22,1,.36,1) .1s, width .8s cubic-bezier(.22,1,.36,1) .1s;
    box-shadow: 0 0 6px rgba(32,201,88,.4);
  }

  /* ── CTA ROW ── */
  .cta-row {
    display: none;
    position: relative; z-index: 1;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 14px 32px 24px;
    animation: fadeIn .3s ease;
  }
  .cta-row.show { display: flex; }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  .cta-btn {
    background: var(--red);
    border: none;
    color: #fff;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .14em;
    padding: 12px 28px;
    border-radius: 2px;
    cursor: pointer;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
    transition: background .2s, transform .15s, box-shadow .2s;
  }
  .cta-btn::after {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(110deg, transparent 35%, rgba(255,255,255,.14) 50%, transparent 65%);
    transform: translateX(-120%);
    transition: transform .5s;
  }
  .cta-btn:hover {
    background: var(--red-hot);
    transform: translateY(-1px);
    box-shadow: 0 4px 20px var(--red-glow);
  }
  .cta-btn:hover::after { transform: translateX(120%); }
  .cta-btn:active { transform: translateY(0); }

  .reset-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Sans', sans-serif;
    font-size: .72rem;
    text-transform: uppercase;
    letter-spacing: .1em;
    padding: 7px 14px;
    border-radius: 2px;
    cursor: pointer;
    transition: border-color .2s, color .2s;
  }
  .reset-btn:hover { border-color: var(--red); color: var(--red-hot); }

  .foot-note {
    margin-left: auto;
    font-size: .68rem;
    color: var(--muted);
    line-height: 1.5;
    text-align: right;
  }
  .foot-note a { color: var(--red-hot); text-decoration: none; }
  .foot-note a:hover { text-decoration: underline; }

  .bottom-stripe {
    height: 3px;
    background: linear-gradient(90deg, transparent 0%, var(--red-dim) 40%, var(--red) 100%);
    margin-top: 0;
  }

  /* ── RESPONSIVE ── */
  @media (max-width: 768px) {
    .cfg-header { padding: 18px 18px 0; }
    .cfg-title  { font-size: 1.5rem; }
    .cfg-tagline { display: none; }
    .step-track { padding: 14px 18px 0; }
    .step-label { display: none; }
    .step-sep   { min-width: 8px; }

    .fields-row {
      grid-template-columns: 1fr 1fr;
      margin: 14px 18px 0;
    }

    .result-panel { margin: 1px 18px 0; }
    .result-top   { flex-direction: column; }
    .result-main  { border-right: none; }
    .stats-grid   { grid-template-columns: repeat(4, 1fr); }
    .stat-box     { padding: 12px 14px; }
    .stat-val     { font-size: 1.3rem; }
    .gain-row     { grid-template-columns: 1fr; }
    .gain-bar-cell:first-child { border-bottom: 1px solid var(--border); }

    .cta-row { padding: 12px 18px 20px; flex-wrap: wrap; }
    .foot-note { text-align: left; margin-left: 0; order: -1; width: 100%; }
  }
</style>
</head>
<body>

<div class="configurator">
  <div class="red-stripe"></div>

  <!-- Header -->
  <div class="cfg-header">
    <div class="cfg-title-block">
      <div class="slash-mark"></div>
      <div>
        <div class="cfg-title">Zoek uw <span>Auto</span></div>
        <div class="cfg-subtitle">Bekijk direct uw vermogen na een stage 1 tuning</div>
      </div>
    </div>
    <div class="cfg-tagline">Stage 1 · DPF · EGR · AdBlue</div>
  </div>

  <!-- Step indicators -->
  <div class="step-track" id="step-track">
    <div class="step-item active" id="si1">
      <div class="step-num"><span>1</span></div>
      <div class="step-label">Merk</div>
    </div>
    <div class="step-sep"></div>
    <div class="step-item" id="si2">
      <div class="step-num"><span>2</span></div>
      <div class="step-label">Model</div>
    </div>
    <div class="step-sep"></div>
    <div class="step-item" id="si3">
      <div class="step-num"><span>3</span></div>
      <div class="step-label">Bouwjaar</div>
    </div>
    <div class="step-sep"></div>
    <div class="step-item" id="si4">
      <div class="step-num"><span>4</span></div>
      <div class="step-label">Motor</div>
    </div>
  </div>

  <p class="loading-msg" id="loading-msg">⏳ Data laden…</p>
  <p class="error-msg"   id="error-msg">⚠️ Kon autodata niet laden. Controleer of cars.json beschikbaar is.</p>

  <!-- Dropdowns row -->
  <div class="fields-row">
    <div class="field-cell" id="f-merk">
      <div class="field-label"><span class="dot"></span>Merk</div>
      <div class="sel-wrap">
        <select id="sel-merk" onchange="onMerk()">
          <option value="">Selecteer merk</option>
        </select>
      </div>
    </div>
    <div class="field-cell" id="f-model">
      <div class="field-label"><span class="dot"></span>Model</div>
      <div class="sel-wrap">
        <select id="sel-model" onchange="onModel()">
          <option value="">Selecteer model</option>
        </select>
      </div>
    </div>
    <div class="field-cell" id="f-jaar">
      <div class="field-label"><span class="dot"></span>Generatie</div>
      <div class="sel-wrap">
        <select id="sel-jaar" onchange="onJaar()">
          <option value="">Selecteer generatie</option>
        </select>
      </div>
    </div>
    <div class="field-cell" id="f-motor">
      <div class="field-label"><span class="dot"></span>Motor / Vermogen</div>
      <div class="sel-wrap">
        <select id="sel-motor" onchange="onMotor()">
          <option value="">Selecteer motor</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Result panel -->
  <div class="result-panel" id="result-panel">

    <!-- Top row: car info + 4 stat boxes -->
    <div class="result-top">
      <div class="result-main">
        <div class="result-eyebrow">Uw voertuig</div>
        <div class="result-car-name" id="r-name">—</div>
        <div class="result-engine" id="r-engine">—</div>
      </div>
      <div class="stats-grid">
        <div class="stat-box">
          <span class="stat-val" id="r-stock-pk">—</span>
          <span class="stat-lbl">Origineel PK</span>
        </div>
        <div class="stat-box">
          <span class="stat-val" id="r-stock-nm">—</span>
          <span class="stat-lbl">Origineel NM</span>
        </div>
        <div class="stat-box new">
          <span class="stat-val" id="r-stage-pk">—</span>
          <span class="stat-lbl">Stage 1 PK</span>
        </div>
        <div class="stat-box new">
          <span class="stat-val" id="r-stage-nm">—</span>
          <span class="stat-lbl">Stage 1 NM</span>
        </div>
      </div>
    </div>

    <!-- Gain bars row -->
    <div class="gain-row">

      <!-- PK bar -->
      <div class="gain-bar-cell">
        <div class="gain-bar-header">
          <span class="gain-bar-label">Vermogen (PK)</span>
          <span class="gain-bar-numbers">
            <span class="before" id="gb-stock-pk">—</span>
            <span class="arrow">→</span>
            <span class="after"  id="gb-stage-pk">—</span>
            <span class="delta"  id="gb-delta-pk">—</span>
          </span>
        </div>
        <div class="bar-track">
          <div class="bar-stock" id="bar-stock-pk" style="width:0%"></div>
          <div class="bar-stage" id="bar-stage-pk" style="width:0%"></div>
          <div class="bar-gain"  id="bar-gain-pk"  style="left:0%;width:0%"></div>
        </div>
      </div>

      <!-- NM bar -->
      <div class="gain-bar-cell">
        <div class="gain-bar-header">
          <span class="gain-bar-label">Koppel (NM)</span>
          <span class="gain-bar-numbers">
            <span class="before" id="gb-stock-nm">—</span>
            <span class="arrow">→</span>
            <span class="after"  id="gb-stage-nm">—</span>
            <span class="delta"  id="gb-delta-nm">—</span>
          </span>
        </div>
        <div class="bar-track">
          <div class="bar-stock" id="bar-stock-nm" style="width:0%"></div>
          <div class="bar-stage" id="bar-stage-nm" style="width:0%"></div>
          <div class="bar-gain"  id="bar-gain-nm"  style="left:0%;width:0%"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- CTA row -->
  <div class="cta-row" id="cta-row">
    <button class="cta-btn" onclick="sendRequest()">Offerte aanvragen</button>
    <button class="reset-btn" onclick="resetForm()">↺ Opnieuw</button>
    <p class="foot-note">
      HS Performance ·
      <a href="https://api.whatsapp.com/send?phone=31639246636" target="_blank">Direct contact</a>
    </p>
  </div>

  <div class="bottom-stripe"></div>
</div>

<script>
const FUEL_ORDER = ['petrol', 'diesel', 'hybrid', 'electric'];
const FUEL_NL    = { petrol:'Benzine', diesel:'Diesel', hybrid:'Hybride', electric:'Elektrisch' };
const DATA_URL   = 'cars.json';

let DB    = null;
let state = { merk:'', model:'', jaar:'', engineKey:'', engineData: null };
const t   = s => s.trim();

document.addEventListener('DOMContentLoaded', () => {
  const loadingEl = document.getElementById('loading-msg');
  const errorEl   = document.getElementById('error-msg');
  loadingEl.classList.add('show');

  fetch(DATA_URL)
    .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
    .then(data => {
      loadingEl.classList.remove('show');
      DB = data;
      fillSelect('sel-merk',
        Object.keys(DB).sort((a, b) => a.localeCompare(b)),
        'Selecteer merk'
      );
      unlock('f-merk');
      activeField('f-merk');
    })
    .catch(err => {
      loadingEl.classList.remove('show');
      errorEl.classList.add('show');
      console.error('Kon cars.json niet laden:', err);
    });
});

function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('si' + i);
    el.className = 'step-item' + (i < n ? ' done' : i === n ? ' active' : '');
  }
}

function unlock(id) { document.getElementById(id).classList.add('unlocked'); }
function lock(id) {
  document.getElementById(id).classList.remove('unlocked');
  document.getElementById(id).classList.remove('active-field');
}
function activeField(id) {
  ['f-merk','f-model','f-jaar','f-motor'].forEach(fid =>
    document.getElementById(fid).classList.remove('active-field')
  );
  document.getElementById(id).classList.add('active-field');
}

function fillSelect(selId, items, placeholder) {
  const sel = document.getElementById(selId);
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  items.forEach(v => {
    const o = document.createElement('option');
    o.value = o.textContent = v;
    sel.appendChild(o);
  });
}

function hideResult() {
  document.getElementById('result-panel').classList.remove('show');
  document.getElementById('cta-row').classList.remove('show');
}

function rawKey(obj, trimmed) {
  return Object.keys(obj).find(k => t(k) === trimmed);
}

function onMerk() {
  const v = document.getElementById('sel-merk').value;
  state = { merk:v, model:'', jaar:'', engineKey:'', engineData:null };
  fillSelect('sel-model', [], 'Selecteer model');
  fillSelect('sel-jaar',  [], 'Selecteer jaar');
  fillSelect('sel-motor', [], 'Selecteer motor');
  ['f-model','f-jaar','f-motor'].forEach(lock);
  hideResult();
  if (v) {
    activeField('f-model');
    const models = Object.keys(DB[v]).map(t).sort((a,b) => a.localeCompare(b));
    fillSelect('sel-model', models, 'Selecteer model');
    unlock('f-model');
    setStep(2);
  } else {
    activeField('f-merk');
    setStep(1);
  }
}

function onModel() {
  const v = document.getElementById('sel-model').value;
  state.model = v; state.jaar=''; state.engineKey=''; state.engineData=null;
  fillSelect('sel-jaar',  [], 'Selecteer jaar');
  fillSelect('sel-motor', [], 'Selecteer motor');
  ['f-jaar','f-motor'].forEach(lock);
  hideResult();
  if (v) {
    activeField('f-jaar');
    const rk    = rawKey(DB[state.merk], v);
    const years = Object.keys(DB[state.merk][rk]).map(t).sort((a,b) => a.localeCompare(b));
    fillSelect('sel-jaar', years, 'Selecteer jaar');
    unlock('f-jaar');
    setStep(3);
  } else {
    activeField('f-model');
    setStep(2);
  }
}

function onJaar() {
  const v = document.getElementById('sel-jaar').value;
  state.jaar = v; state.engineKey=''; state.engineData=null;
  fillSelect('sel-motor', [], 'Selecteer motor');
  lock('f-motor');
  hideResult();
  if (v) {
    activeField('f-motor');
    const rm      = rawKey(DB[state.merk], state.model);
    const ry      = rawKey(DB[state.merk][rm], v);
    const engines = DB[state.merk][rm][ry];

    const groups = {};
    Object.entries(engines).forEach(([rk, data]) => {
      const fuel = data.fuel || 'petrol';
      if (!groups[fuel]) groups[fuel] = [];
      groups[fuel].push({ key: t(rk), hp: data.stock_hp });
    });

    const sel = document.getElementById('sel-motor');
    sel.innerHTML = '<option value="">Selecteer motor</option>';
    FUEL_ORDER.forEach(fuel => {
      if (!groups[fuel]) return;
      const grp = document.createElement('optgroup');
      grp.label = FUEL_NL[fuel] || fuel;
      groups[fuel].sort((a,b) => a.hp - b.hp).forEach(({ key }) => {
        const o = document.createElement('option');
        o.value = o.textContent = key;
        grp.appendChild(o);
      });
      sel.appendChild(grp);
    });
    unlock('f-motor');
    setStep(4);
  } else {
    activeField('f-jaar');
    setStep(3);
  }
}

function onMotor() {
  const v = document.getElementById('sel-motor').value;
  if (!v) { hideResult(); return; }

  const rm  = rawKey(DB[state.merk], state.model);
  const ry  = rawKey(DB[state.merk][rm], state.jaar);
  const eng = DB[state.merk][rm][ry];
  const re  = rawKey(eng, v);

  state.engineKey  = v;
  state.engineData = eng[re];

  ['f-merk','f-model','f-jaar','f-motor'].forEach(id =>
    document.getElementById(id).classList.remove('active-field')
  );

  showResult();
}

function showResult() {
  const e    = state.engineData;
  const fuel = FUEL_NL[e.fuel] || e.fuel;

  const gainPk = e.stage1_hp - e.stock_hp;
  const gainNm = e.stage1_nm - e.stock_nm;

  // Car info
  document.getElementById('r-name').innerHTML =
    `${state.merk} ${state.model} <span class="yr">${state.jaar}</span>`;
  document.getElementById('r-engine').innerHTML =
    `<span class="fuel-badge">${fuel}</span>${state.engineKey}`;

  // Stat boxes
  document.getElementById('r-stock-pk').textContent = e.stock_hp  + ' pk';
  document.getElementById('r-stock-nm').textContent = e.stock_nm  + ' nm';
  document.getElementById('r-stage-pk').textContent = e.stage1_hp + ' pk';
  document.getElementById('r-stage-nm').textContent = e.stage1_nm + ' nm';

  // Gain bar text
  document.getElementById('gb-stock-pk').textContent = e.stock_hp  + ' pk';
  document.getElementById('gb-stage-pk').textContent = e.stage1_hp + ' pk';
  document.getElementById('gb-delta-pk').textContent = '+' + gainPk + ' pk';
  document.getElementById('gb-stock-nm').textContent = e.stock_nm  + ' nm';
  document.getElementById('gb-stage-nm').textContent = e.stage1_nm + ' nm';
  document.getElementById('gb-delta-nm').textContent = '+' + gainNm + ' nm';

  document.getElementById('result-panel').classList.add('show');
  document.getElementById('cta-row').classList.add('show');

  // Animate bars after a short delay (lets the panel render first)
  setTimeout(() => animateBars(e), 60);
}

function animateBars(e) {
  // We scale to 120% of stage1 so there's always breathing room
  const maxPk = e.stage1_hp * 1.2;
  const maxNm = e.stage1_nm * 1.2;

  const stockPkPct = (e.stock_hp  / maxPk * 100).toFixed(1);
  const stagePkPct = (e.stage1_hp / maxPk * 100).toFixed(1);
  const gainPkPct  = ((e.stage1_hp - e.stock_hp) / maxPk * 100).toFixed(1);

  const stockNmPct = (e.stock_nm  / maxNm * 100).toFixed(1);
  const stageNmPct = (e.stage1_nm / maxNm * 100).toFixed(1);
  const gainNmPct  = ((e.stage1_nm - e.stock_nm) / maxNm * 100).toFixed(1);

  // PK bar: red fills to stage1, green gain segment sits on top from stock→stage1
  document.getElementById('bar-stage-pk').style.width  = stagePkPct + '%';
  document.getElementById('bar-gain-pk').style.left    = stockPkPct + '%';
  document.getElementById('bar-gain-pk').style.width   = gainPkPct  + '%';

  // NM bar
  document.getElementById('bar-stage-nm').style.width  = stageNmPct + '%';
  document.getElementById('bar-gain-nm').style.left    = stockNmPct + '%';
  document.getElementById('bar-gain-nm').style.width   = gainNmPct  + '%';
}

function sendRequest() {
  const e    = state.engineData;
  const fuel = FUEL_NL[e.fuel] || e.fuel;
  const msg  = encodeURIComponent(
    `Hallo HS Performance, ik wil graag een offerte voor chiptuning van mijn ` +
    `${state.merk} ${state.model} (${state.jaar}), ${fuel}, ${state.engineKey}.`
  );
  window.open(`https://api.whatsapp.com/send?phone=31639246636&text=${msg}`, '_blank');
}

function resetForm() {
  state = { merk:'', model:'', jaar:'', engineKey:'', engineData:null };
  document.getElementById('sel-merk').value = '';
  fillSelect('sel-model', [], 'Selecteer model');
  fillSelect('sel-jaar',  [], 'Selecteer jaar');
  fillSelect('sel-motor', [], 'Selecteer motor');
  ['f-model','f-jaar','f-motor'].forEach(lock);
  activeField('f-merk');
  hideResult();
  setStep(1);

  // Reset bars
  ['pk','nm'].forEach(t => {
    document.getElementById('bar-stage-' + t).style.width = '0%';
    document.getElementById('bar-gain-'  + t).style.left  = '0%';
    document.getElementById('bar-gain-'  + t).style.width = '0%';
  });
}
</script>
</body>
</html>
